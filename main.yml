---
# Setup Nginx
- hosts: all
  gather_facts: no
  pre_tasks:
    - raw: zypper -n install python3-virtualenv
  tasks:

  - name: Install a list of packages
    zypper:
      name: "{{ packages }}"
    vars:
      packages:
      - nginx
      - curl
    ignore_errors: true
    become: yes

  - name: Make sure a service nginx is running
    systemd:
      state: started
      name: nginx  
    become: yes

  - name: enable service nginx and ensure it is not masked
    systemd:
      name: nginx
      enabled: yes
      masked: no
    become: yes

  - name: Manually create the initial virtualenv
    command: virtualenv /srv/www/htdocs/myenv -p /usr/bin/python creates="/srv/www/htdocs/myenv"
    become: yes

  - name: Install requirements
    pip: 
      requirements=/srv/www/htdocs/preinstall.txt 
      virtualenv=/srv/www/htdocs/myenv
    become: yes